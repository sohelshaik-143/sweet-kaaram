<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard - Sweet & Karam</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="/socket.io/socket.io.js"></script>
</head>
<body class="bg-gray-100 font-sans">

<header class="bg-red-700 text-white p-6 text-center">
  <h1 class="text-4xl font-bold">üç¨ Sweet & Karam - Admin Dashboard</h1>
</header>

<main class="container mx-auto my-10 px-4">

  <div class="flex flex-wrap gap-3 justify-between items-center mb-6">
    <h2 class="text-2xl font-semibold">All Orders</h2>
    <div class="flex gap-3">
      <button onclick="resetOrders()" 
              class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700 transition">
        üßΩ Clear Orders
      </button>
    </div>
  </div>

  <div id="ordersTable" class="overflow-x-auto">
    <table class="min-w-full bg-white rounded shadow">
      <thead class="bg-red-700 text-white">
        <tr>
          <th class="py-2 px-4">S.No</th>
          <th class="py-2 px-4">Date</th>
          <th class="py-2 px-4">Name</th>
          <th class="py-2 px-4">Phone</th>
          <th class="py-2 px-4">Item</th>
          <th class="py-2 px-4">Qty</th>
          <th class="py-2 px-4">Amount</th>
          <th class="py-2 px-4">Tracking ID</th>
          <th class="py-2 px-4">Status</th>
          <th class="py-2 px-4">Action</th>
        </tr>
      </thead>
      <tbody id="ordersBody"></tbody>
    </table>
  </div>

</main>

<script>
const socket = io();

function renderOrders(orders) {
  const tbody = document.getElementById('ordersBody');
  tbody.innerHTML = '';

  orders.slice().reverse().forEach((o, index) => {
    const tr = document.createElement('tr');
    tr.className = 'border-b text-center';

    const statusColor =
      o['Order Status']?.toLowerCase() === 'delivered'
        ? 'text-green-600'
        : o['Order Status']?.toLowerCase() === 'out for delivery'
        ? 'text-blue-600'
        : 'text-yellow-600';

    tr.innerHTML = `
      <td class="py-2 px-4">${index+1}</td>
      <td class="py-2 px-4">${o['Date'] || new Date(o.createdAt).toLocaleString()}</td>
      <td class="py-2 px-4">${o['Name'] || '-'}</td>
      <td class="py-2 px-4">${o['Ph no'] || '-'}</td>
      <td class="py-2 px-4">${o['Item'] || '-'}</td>
      <td class="py-2 px-4">${o['Quantity'] || '-'}</td>
      <td class="py-2 px-4">‚Çπ${o['Amount'] || 0}</td>
      <td class="py-2 px-4 font-mono">${o['Tracking ID'] || '-'}</td>
      <td class="py-2 px-4 font-bold ${statusColor}">${o['Order Status'] || 'Pending'}</td>
      <td class="py-2 px-4">
        ${
          o['Order Status'] !== 'Delivered'
            ? `<button onclick="markDelivered('${o['Tracking ID']}')" 
                class="bg-green-600 text-white px-3 py-1 rounded hover:bg-green-700">Mark as Delivered</button>`
            : `<span class="text-gray-500">‚úÖ Done</span>`
        }
      </td>
    `;
    tbody.appendChild(tr);
  });
}

// Receive all orders initially
socket.on('all-orders', (orders) => renderOrders(orders));

// Receive new order in real-time
socket.on('new-order', (order) => {
  const currentOrders = Array.from(document.getElementById('ordersBody').children).map((tr, idx) => ({
    'S.No': idx + 1,
    'Date': tr.cells[1].innerText,
    'Name': tr.cells[2].innerText,
    'Ph no': tr.cells[3].innerText,
    'Item': tr.cells[4].innerText,
    'Quantity': tr.cells[5].innerText,
    'Amount': tr.cells[6].innerText.replace('‚Çπ', ''),
    'Tracking ID': tr.cells[7].innerText,
    'Order Status': tr.cells[8].innerText
  }));
  currentOrders.push(order);
  renderOrders(currentOrders);
});

// Mark as Delivered
async function markDelivered(trackingId) {
  if (!confirm(`Mark order ${trackingId} as Delivered?`)) return;
  const res = await fetch('/update-status', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ trackingId, newStatus: 'Delivered' })
  });
  const data = await res.json();
  if (!res.ok) alert('‚ùå ' + data.error);
}

// Clear all orders manually
async function resetOrders() {
  if (!confirm('‚ö† Are you sure you want to clear all orders?')) return;
  const res = await fetch('/reset-orders', { method: 'POST' });
  const data = await res.json();
  if (!res.ok) alert('‚ùå ' + data.error);
}
</script>

</body>
</html>
