<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Admin Dashboard - Sweet & Karam</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="/socket.io/socket.io.js"></script>
<style>
  @keyframes highlight { 0% { background-color: #fef3c7; } 100% { background-color: white; } }
  .new-order { animation: highlight 2s ease; }
</style>
</head>
<body class="bg-gray-100 font-sans">

<header class="bg-red-700 text-white p-6 text-center shadow">
  <h1 class="text-4xl font-bold">üç¨ Sweet & Karam - Admin Dashboard</h1>
</header>

<main class="container mx-auto my-10 px-4">

  <div class="flex flex-wrap gap-3 justify-between items-center mb-6">
    <a href="/download-excel"
       class="bg-green-600 text-white px-5 py-3 rounded-lg text-lg font-semibold hover:bg-green-700 transition shadow-lg">
      ‚¨á Download Excel
    </a>
    <button onclick="alert('Clear Orders disabled! Data is preserved permanently until admin manually deletes.')"
            class="bg-red-600 text-white px-5 py-3 rounded-lg text-lg font-semibold hover:bg-red-700 transition shadow-lg">
      üßπ Clear Orders
    </button>
  </div>

  <div id="ordersTable" class="overflow-x-auto bg-white rounded shadow">
    <table class="min-w-full">
      <thead class="bg-red-700 text-white">
        <tr>
          <th class="py-2 px-4">S.No</th>
          <th class="py-2 px-4">Date</th>
          <th class="py-2 px-4">Name</th>
          <th class="py-2 px-4">Phone</th>
          <th class="py-2 px-4">Item(s)</th>
          <th class="py-2 px-4">Qty</th>
          <th class="py-2 px-4">Amount</th>
          <th class="py-2 px-4">Tracking ID</th>
          <th class="py-2 px-4">Status</th>
          <th class="py-2 px-4">Action</th>
        </tr>
      </thead>
      <tbody id="ordersBody"></tbody>
    </table>
  </div>

  <div class="my-8 p-4 bg-white rounded shadow">
    <h2 class="text-xl font-bold mb-4">‚ûï Add New Order</h2>
    <form id="addOrderForm" class="flex flex-col gap-3">
      <input type="text" id="name" placeholder="Customer Name" class="p-2 border rounded"/>
      <input type="text" id="phone" placeholder="Phone" class="p-2 border rounded"/>
      <textarea id="items" placeholder='Items JSON: [{"name":"Choco","price":50,"qty":2}]' 
                class="p-2 border rounded h-24"></textarea>
      <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition">Place Order</button>
    </form>
  </div>

</main>

<script>
const socket = io();
let currentOrders = [];

function formatItems(items) {
  if (!items) return '-';
  return Array.isArray(items) ? items.map(i => `${i.name} x${i.qty}`).join(', ') : items;
}

function renderOrders() {
  const tbody = document.getElementById('ordersBody');
  tbody.innerHTML = '';

  currentOrders.slice().reverse().forEach((o, index) => {
    const tr = document.createElement('tr');
    tr.className = 'border-b text-center hover:bg-gray-50';

    const status = o['Order Status'] || 'Pending';
    const statusLower = status.toLowerCase();
    const statusColor =
      statusLower === 'delivered' ? 'text-green-600' :
      statusLower === 'out for delivery' ? 'text-blue-600' : 'text-yellow-600';

    const dateDisplay = o.createdAt ? new Date(o.createdAt).toLocaleString() : '-';
    const itemsList = formatItems(o.items);
    const qtyTotal = Array.isArray(o.items) ? o.items.reduce((sum,i)=>sum+(i.qty||0),0) : 0;
    const totalAmount = Array.isArray(o.items) ? o.items.reduce((sum,i)=>sum+(i.price*i.qty),0) : 0;

    let actionBtn = '';
    if (statusLower === 'pending') {
      actionBtn = `<button onclick="updateStatus('${o['Tracking ID']}', 'Out for Delivery')"
                     class="bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700 transition">
                     Out for Delivery
                   </button>`;
    } else if (statusLower === 'out for delivery') {
      actionBtn = `<button onclick="updateStatus('${o['Tracking ID']}', 'Delivered')"
                     class="bg-green-600 text-white px-3 py-1 rounded hover:bg-green-700 transition">
                     Mark Delivered
                   </button>`;
    } else {
      actionBtn = `<span class="text-gray-500">‚úÖ Done</span>`;
    }

    tr.innerHTML = `
      <td class="py-2 px-4">${index + 1}</td>
      <td class="py-2 px-4">${dateDisplay}</td>
      <td class="py-2 px-4">${o.name || '-'}</td>
      <td class="py-2 px-4">${o.phone || '-'}</td>
      <td class="py-2 px-4">${itemsList}</td>
      <td class="py-2 px-4">${qtyTotal}</td>
      <td class="py-2 px-4">‚Çπ${totalAmount}</td>
      <td class="py-2 px-4 font-mono">${o['Tracking ID'] || '-'}</td>
      <td class="py-2 px-4 font-bold ${statusColor}">${status}</td>
      <td class="py-2 px-4">${actionBtn}</td>
    `;
    tbody.appendChild(tr);
  });
}

async function updateStatus(trackingId, status) {
  try {
    const res = await fetch('/update-status', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ trackingId, newStatus: status })
    });
    const data = await res.json();
    if (!data.success) alert(data.error || '‚ùå Failed to update status');
  } catch (err) { console.error(err); alert('‚ùå Server error'); }
}

socket.on('all-orders', orders => { currentOrders = orders; renderOrders(); });
socket.on('new-order', order => { currentOrders.push(order); renderOrders(); });

(async function fetchOrders() {
  try {
    const res = await fetch('/api/orders');
    const orders = await res.json();
    currentOrders = orders;
    renderOrders();
  } catch (err) { console.error(err); }
})();

document.getElementById('addOrderForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const name = document.getElementById('name').value.trim();
  const phone = document.getElementById('phone').value.trim();
  let items = [];
  try { items = JSON.parse(document.getElementById('items').value); } 
  catch (err) { alert('Invalid items JSON'); return; }

  const orderData = { name, phone, items };
  try {
    const res = await fetch('/order', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(orderData)
    });
    const response = await res.json();
    if (response.success) {
      alert(`‚úÖ Order Placed! Tracking ID: ${response.orderId}`);
      document.getElementById('addOrderForm').reset();
    } else { alert('‚ùå Failed to place order'); }
  } catch (err) { console.error(err); alert('‚ùå Server error'); }
});
</script>

</body>
</html>
