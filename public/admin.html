<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Admin Dashboard - Sweet & Karam</title>

<!-- Tailwind + Socket -->
<script src="https://cdn.tailwindcss.com"></script>
<script src="/socket.io/socket.io.js"></script>

<style>
@keyframes highlight {
  0% { background-color: #fef3c7; }
  100% { background-color: white; }
}
.new-order { animation: highlight 2s ease; }
</style>
</head>
<body class="bg-gray-100 font-sans">

<header class="bg-red-700 text-white p-6 text-center shadow">
  <h1 class="text-4xl font-bold">üç¨ Sweet & Karam - Admin Dashboard</h1>
</header>

<main class="container mx-auto my-10 px-4">
  <div class="flex flex-wrap gap-3 justify-between items-center mb-6">
    <a href="/download-excel" class="bg-green-600 text-white px-5 py-3 rounded-lg text-lg font-semibold hover:bg-green-700 transition shadow-lg">
       ‚¨á Download Excel
    </a>
    <button onclick="alert('Clear Orders disabled! Data is preserved.')"
       class="bg-red-600 text-white px-5 py-3 rounded-lg text-lg font-semibold hover:bg-red-700 transition shadow-lg">
       üßπ Clear Orders
    </button>
  </div>

  <div id="ordersTable" class="overflow-x-auto bg-white rounded shadow">
    <table class="min-w-full table-auto">
      <thead class="bg-red-700 text-white">
        <tr>
          <th class="py-2 px-4">S.No</th>
          <th class="py-2 px-4">Date</th>
          <th class="py-2 px-4">Name</th>
          <th class="py-2 px-4">Phone</th>
          <th class="py-2 px-4">Item(s)</th>
          <th class="py-2 px-4">Qty</th>
          <th class="py-2 px-4">Amount</th>
          <th class="py-2 px-4">Tracking ID</th>
          <th class="py-2 px-4">Status</th>
          <th class="py-2 px-4">Action</th>
        </tr>
      </thead>
      <tbody id="ordersBody"></tbody>
    </table>
  </div>

  <div class="my-8 p-4 bg-white rounded shadow">
    <h2 class="text-xl font-bold mb-4">‚ûï Add New Order</h2>
    <form id="addOrderForm" class="flex flex-col gap-3">
      <input type="text" id="name" placeholder="Customer Name" class="p-2 border rounded" required />
      <input type="text" id="phone" placeholder="Phone" class="p-2 border rounded" required />
      <textarea id="items" placeholder='Items JSON: [{"name":"Choco","price":50,"qty":2}]' class="p-2 border rounded h-24" required></textarea>
      <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition">Place Order</button>
    </form>
  </div>
</main>

<script>
const tbody = document.getElementById('ordersBody');
let currentOrders = [];

// Parse items safely
function parseItems(order) {
  if (!order.items) return [];
  if (typeof order.items === 'string') {
    try { return JSON.parse(order.items); } catch { return []; }
  }
  return Array.isArray(order.items) ? order.items : [];
}

// Render all orders
function renderOrders(newOrderId = null) {
  tbody.innerHTML = '';
  currentOrders.slice().reverse().forEach((order, index) => {
    const tr = document.createElement('tr');
    tr.className = 'border-b text-center hover:bg-gray-50';
    if (order['Tracking ID'] === newOrderId) tr.classList.add('new-order');

    const items = parseItems(order);
    const itemsList = items.length ? items.map(i => `${i.name || 'Unnamed'} (${i.qty || 1} x ‚Çπ${i.price || 0})`).join(', ') : '-';
    const qtyTotal = items.reduce((sum, i) => sum + (i.qty || 0), 0);
    const totalAmount = order.totalAmount ?? items.reduce((sum, i) => sum + ((i.qty||0)*(i.price||0)), 0);

    const status = order['Order Status'] || 'Pending';
    const statusColor = status.toLowerCase() === 'delivered' ? 'text-green-600' :
                        status.toLowerCase() === 'out for delivery' ? 'text-blue-600' : 'text-yellow-600';
    const dateDisplay = order.createdAt ? new Date(order.createdAt).toLocaleString() : '-';

    let actionBtn = '';
    if (status.toLowerCase() === 'pending') {
      actionBtn = `<button onclick="updateStatus('${order['Tracking ID']}','Out for Delivery')" class='bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700 transition'>Out for Delivery</button>`;
    } else if (status.toLowerCase() === 'out for delivery') {
      actionBtn = `<button onclick="updateStatus('${order['Tracking ID']}','Delivered')" class='bg-green-600 text-white px-3 py-1 rounded hover:bg-green-700 transition'>Mark Delivered</button>`;
    } else {
      actionBtn = `<span class="text-gray-500">‚úÖ Done</span>`;
    }

    tr.innerHTML = `
      <td class="py-2 px-4">${index+1}</td>
      <td class="py-2 px-4">${dateDisplay}</td>
      <td class="py-2 px-4">${order.name || '-'}</td>
      <td class="py-2 px-4">${order.phone || '-'}</td>
      <td class="py-2 px-4">${itemsList}</td>
      <td class="py-2 px-4">${qtyTotal}</td>
      <td class="py-2 px-4">‚Çπ${totalAmount}</td>
      <td class="py-2 px-4 font-mono">${order['Tracking ID'] || '-'}</td>
      <td class="py-2 px-4 font-bold ${statusColor}">${status}</td>
      <td class="py-2 px-4">${actionBtn}</td>
    `;
    tbody.appendChild(tr);
  });
}

// Update order status
async function updateStatus(trackingId, newStatus) {
  try {
    const res = await fetch('/update-status', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({trackingId,newStatus})
    });
    const data = await res.json();
    if (!data.success) throw new Error(data.error || 'Failed');
    const index = currentOrders.findIndex(o => o['Tracking ID'] === trackingId);
    if (index > -1) { currentOrders[index]['Order Status'] = newStatus; renderOrders(trackingId); }
  } catch(err) { console.error(err); alert('‚ùå Failed to update status'); }
}

// Socket.IO
const socket = io();
socket.on('all-orders', orders => { currentOrders = orders; renderOrders(); });
socket.on('new-order', order => { currentOrders.push(order); renderOrders(order['Tracking ID']); });

// Fetch fallback
async function fetchOrders() {
  try { const res = await fetch('/api/orders'); currentOrders = await res.json(); renderOrders(); }
  catch(err){ console.error(err); }
}
fetchOrders();

// Add new order
document.getElementById('addOrderForm').addEventListener('submit', async e => {
  e.preventDefault();
  const name = document.getElementById('name').value.trim();
  const phone = document.getElementById('phone').value.trim();
  let items = [];
  try { items = JSON.parse(document.getElementById('items').value); } catch { alert('‚ùå Invalid items JSON'); return; }
  if (!name || !phone || !items.length) { alert('‚ö† Fill all fields'); return; }

  // Normalize items
  items = items.map(i => ({ name: i.name||'Unnamed', qty: Number(i.qty)||1, price: Number(i.price)||0 }));

  try {
    const res = await fetch('/order', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({name,phone,items})
    });
    const data = await res.json();
    if (data.success) { alert(`‚úÖ Order Placed! Tracking ID: ${data.orderId}`); document.getElementById('addOrderForm').reset(); }
    else alert('‚ùå Failed to place order');
  } catch(err){ console.error(err); alert('‚ùå Server error'); }
});
</script>
</body>
</html>
