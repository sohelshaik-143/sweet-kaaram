<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard - Sweet & Karam</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 font-sans">

  <!-- Header -->
  <header class="bg-red-700 text-white p-6 text-center">
    <h1 class="text-4xl font-bold">üç¨ Sweet & Karam - Admin Dashboard</h1>
  </header>

  <main class="container mx-auto my-10 px-4">

    <!-- Top bar -->
    <div class="flex flex-wrap gap-3 justify-between items-center mb-6">
      <h2 class="text-2xl font-semibold">All Orders</h2>

      <div class="flex gap-3">
        <!-- Download Excel -->
        <a href="/download-excel" 
           class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition">
          ‚¨á Download Excel
        </a>

        <!-- Clear Orders Button -->
        <button onclick="resetOrders()" 
                class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700 transition">
          üßΩ Clear Orders
        </button>
      </div>
    </div>

    <!-- Orders Table -->
    <div id="ordersTable" class="overflow-x-auto">
      <table class="min-w-full bg-white rounded shadow">
        <thead class="bg-red-700 text-white">
          <tr>
            <th class="py-2 px-4">S.No</th>
            <th class="py-2 px-4">Date</th>
            <th class="py-2 px-4">Name</th>
            <th class="py-2 px-4">Phone</th>
            <th class="py-2 px-4">Item</th>
            <th class="py-2 px-4">Qty</th>
            <th class="py-2 px-4">Amount</th>
            <th class="py-2 px-4">Tracking ID</th>
            <th class="py-2 px-4">Status</th>
            <th class="py-2 px-4">Action</th>
          </tr>
        </thead>
        <tbody id="ordersBody">
          <!-- Orders will be injected here -->
        </tbody>
      </table>
    </div>

  </main>

  <script>
    // Load Orders
    async function loadOrders() {
      try {
        const res = await fetch('/api/orders');
        const orders = await res.json();
        const tbody = document.getElementById('ordersBody');
        tbody.innerHTML = '';

        orders.slice().reverse().forEach(o => {
          const tr = document.createElement('tr');
          tr.className = 'border-b text-center';

          const statusColor =
            o['Order Status'].toLowerCase() === 'delivered'
              ? 'text-green-600'
              : o['Order Status'].toLowerCase() === 'out for delivery'
              ? 'text-blue-600'
              : 'text-yellow-600';

          tr.innerHTML = `
            <td class="py-2 px-4">${o['S.No']}</td>
            <td class="py-2 px-4">${o['Date']}</td>
            <td class="py-2 px-4">${o['Name']}</td>
            <td class="py-2 px-4">${o['Ph no']}</td>
            <td class="py-2 px-4">${o['Item']}</td>
            <td class="py-2 px-4">${o['Quantity']}</td>
            <td class="py-2 px-4">‚Çπ${o['Amount']}</td>
            <td class="py-2 px-4 font-mono">${o['Tracking ID']}</td>
            <td class="py-2 px-4 font-bold ${statusColor}">${o['Order Status']}</td>
            <td class="py-2 px-4">
              ${
                o['Order Status'] !== 'Delivered'
                  ? `<button onclick="markDelivered('${o['Tracking ID']}')" 
                      class="bg-green-600 text-white px-3 py-1 rounded hover:bg-green-700">
                      Mark as Delivered
                     </button>`
                  : `<span class="text-gray-500">‚úÖ Done</span>`
              }
            </td>
          `;
          tbody.appendChild(tr);
        });
      } catch (err) {
        console.error('‚ùå Server error while loading orders:', err);
      }
    }

    // Mark Order as Delivered
    async function markDelivered(trackingId) {
      if (!confirm(`Mark order ${trackingId} as Delivered?`)) return;

      try {
        const res = await fetch('/update-status', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ trackingId, newStatus: 'Delivered' })
        });

        const data = await res.json();
        if (res.ok) alert(data.message);
        else alert('‚ùå Failed: ' + data.error);

        loadOrders();
      } catch (err) {
        alert('‚ùå Server error while updating status.');
        console.error(err);
      }
    }

    // üßΩ Clear All Orders
    async function resetOrders() {
      if (!confirm('‚ö† Are you sure you want to clear all orders?')) return;

      try {
        const res = await fetch('/reset-orders', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });

        const data = await res.json();
        if (res.ok) {
          alert(data.message);
          loadOrders();
        } else {
          alert('‚ùå Failed: ' + data.error);
        }
      } catch (err) {
        alert('‚ùå Server error while resetting orders.');
        console.error(err);
      }
    }

    // Load orders on page load
    loadOrders();
  </script>

</body>
</html>
