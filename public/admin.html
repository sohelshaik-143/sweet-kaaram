<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Dashboard - Sweet & Karam</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="/socket.io/socket.io.js"></script>
</head>
<body class="bg-gray-100 font-sans">

  <!-- Header -->
  <header class="bg-red-700 text-white p-6 text-center shadow">
    <h1 class="text-4xl font-bold">üç¨ Sweet & Karam - Admin Dashboard</h1>
  </header>

  <main class="container mx-auto my-10 px-4">

    <!-- Top Buttons -->
    <div class="flex flex-wrap gap-3 justify-end items-center mb-6">
      <a href="/download-excel"
         class="bg-green-600 text-white px-5 py-3 rounded-lg text-lg font-semibold hover:bg-green-700 transition shadow-lg">
        ‚¨á Download Excel
      </a>

      <button onclick="resetOrders()"
              class="bg-red-600 text-white px-5 py-3 rounded-lg text-lg font-semibold hover:bg-red-700 transition shadow-lg">
        üßπ Clear Orders
      </button>
    </div>

    <!-- Orders Table -->
    <div id="ordersTable" class="overflow-x-auto bg-white rounded shadow">
      <table class="min-w-full">
        <thead class="bg-red-700 text-white">
          <tr>
            <th class="py-2 px-4">S.No</th>
            <th class="py-2 px-4">Date</th>
            <th class="py-2 px-4">Name</th>
            <th class="py-2 px-4">Phone</th>
            <th class="py-2 px-4">Item(s)</th>
            <th class="py-2 px-4">Qty</th>
            <th class="py-2 px-4">Amount</th>
            <th class="py-2 px-4">Tracking ID</th>
            <th class="py-2 px-4">Status</th>
            <th class="py-2 px-4">Action</th>
          </tr>
        </thead>
        <tbody id="ordersBody"></tbody>
      </table>
    </div>

  </main>

  <script>
    const socket = io();
    let currentOrders = [];

    // Render orders
    function renderOrders() {
      const tbody = document.getElementById('ordersBody');
      tbody.innerHTML = '';

      currentOrders.slice().reverse().forEach((o, index) => {
        const tr = document.createElement('tr');
        tr.className = 'border-b text-center hover:bg-gray-50';

        const status = o.status || o['Order Status'] || 'Pending';
        const statusLower = status.toLowerCase();
        const statusColor =
          statusLower === 'delivered'
            ? 'text-green-600'
            : statusLower === 'out for delivery'
            ? 'text-blue-600'
            : 'text-yellow-600';

        const dateDisplay = o.timestamp || o.createdAt
          ? new Date(o.timestamp || o.createdAt).toLocaleString()
          : '-';

        const itemsList = Array.isArray(o.items) && o.items.length
          ? o.items.map(i => `${i.name} x${i.qty}`).join(', ')
          : o.Item || '-';
        const qtyTotal = Array.isArray(o.items) && o.items.length
          ? o.items.reduce((sum, i) => sum + (i.qty || 0), 0)
          : o.Quantity || o.Qty || '-';

        let actionBtn = '';
        if (statusLower === 'pending') {
          actionBtn = `<button onclick="markOutForDelivery('${o['Tracking ID']}')"
                          class="bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700 transition">
                          Out for Delivery
                       </button>`;
        } else if (statusLower === 'out for delivery') {
          actionBtn = `<button onclick="markDelivered('${o['Tracking ID']}')"
                          class="bg-green-600 text-white px-3 py-1 rounded hover:bg-green-700 transition">
                          Mark Delivered
                       </button>`;
        } else {
          actionBtn = `<span class="text-gray-500">‚úÖ Done</span>`;
        }

        tr.innerHTML = `
          <td class="py-2 px-4">${index + 1}</td>
          <td class="py-2 px-4">${dateDisplay}</td>
          <td class="py-2 px-4">${o.Name || o.name || '-'}</td>
          <td class="py-2 px-4">${o['Ph no'] || o.Phone || o.phone || '-'}</td>
          <td class="py-2 px-4">${itemsList}</td>
          <td class="py-2 px-4">${qtyTotal}</td>
          <td class="py-2 px-4">‚Çπ${o.Amount || o.total || 0}</td>
          <td class="py-2 px-4 font-mono">${o['Tracking ID'] || '-'}</td>
          <td class="py-2 px-4 font-bold ${statusColor}" id="status-${o['Tracking ID']}">${status}</td>
          <td class="py-2 px-4">${actionBtn}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    // Update status helper
    async function updateStatus(trackingId, status) {
      try {
        const res = await fetch('/update-status', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ trackingId, newStatus: status })
        });
        const data = await res.json();
        if (!res.ok) alert('‚ùå ' + data.error);
      } catch (err) {
        console.error(err);
        alert('‚ùå Server error');
      }
    }

    // Status actions
    async function markOutForDelivery(trackingId) {
      if (!confirm(`Mark order ${trackingId} as Out for Delivery?`)) return;
      await updateStatus(trackingId, 'Out for Delivery');
    }

    async function markDelivered(trackingId) {
      if (!confirm(`Mark order ${trackingId} as Delivered?`)) return;
      await updateStatus(trackingId, 'Delivered');
    }

    // Clear orders (does not remove orders from dashboard live)
    async function resetOrders() {
      if (!confirm('‚ö† Are you sure you want to clear all orders?')) return;
      try {
        const res = await fetch('/reset-orders', { method: 'POST' });
        const data = await res.json();
        if (!res.ok) alert('‚ùå ' + data.error);
      } catch (err) {
        console.error(err);
        alert('‚ùå Server error');
      }
    }

    // Socket listeners
    socket.on('all-orders', (orders) => {
      currentOrders = orders; // keep all previous orders
      renderOrders();
    });

    socket.on('new-order', (order) => {
      currentOrders.push(order);
      renderOrders();
    });

    // Initial fetch fallback
    async function fetchOrders() {
      try {
        const res = await fetch('/api/orders');
        const orders = await res.json();
        currentOrders = orders;
        renderOrders();
      } catch (err) {
        console.error('Error fetching orders:', err);
      }
    }

    fetchOrders();
  </script>

</body>
</html>
